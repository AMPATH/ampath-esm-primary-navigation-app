{"version":3,"file":"import-map-overrides-server.js","sources":["../src/server/server-api.js"],"sourcesContent":["import cookie from \"cookie\";\n\nconst cookiePrefix = \"import-map-override:\";\nconst portRegex = /^\\d+$/g;\n\n/**\n * @typedef {\n *   imports: object,\n *   scopes?: object\n * } ImportMap\n *\n * @param {ImportMap} importMap\n * @param {overrides} object\n * @returns {ImportMap}\n */\nexport function applyOverrides(importMap, overrides) {\n  const newMap = {\n    imports: { ...importMap.imports },\n    scopes: { ...(importMap.scopes || {}) },\n  };\n  for (let key in overrides) {\n    newMap.imports[key] = overrides[key];\n  }\n\n  return newMap;\n}\n\n/**\n *\n * @param {import('http').IncomingMessage} req\n * @returns {ImportMap}\n */\nexport function getOverridesFromCookies(\n  req,\n  getUrlFromPort = defaultGetUrlFromPort\n) {\n  const parsedCookies = cookie.parse(req.headers[\"cookie\"] || \"\");\n\n  const overrides = {};\n\n  for (let cookieName in parsedCookies) {\n    if (cookieName.startsWith(cookiePrefix)) {\n      const moduleName = cookieName.slice(cookiePrefix.length);\n\n      // skip empty string\n      if (moduleName) {\n        let url = parsedCookies[cookieName];\n        if (portRegex.test(url)) {\n          url = (getUrlFromPort || defaultGetUrlFromPort)(url, moduleName, req);\n        }\n\n        if (url.startsWith(\"//\")) {\n          url = `${req.protocol}:${url}`;\n        }\n\n        overrides[moduleName] = url;\n      }\n    }\n  }\n\n  return overrides;\n}\n\nfunction defaultGetUrlFromPort(port, moduleName, req) {\n  const fileName = moduleName.replace(/@/g, \"\").replace(/\\//g, \"-\");\n  return `${req.protocol}://localhost:${port}/${fileName}`;\n}\n"],"names":["portRegex","applyOverrides","importMap","overrides","newMap","imports","scopes","key","getOverridesFromCookies","req","getUrlFromPort","defaultGetUrlFromPort","parsedCookies","cookie","parse","headers","cookieName","startsWith","moduleName","slice","cookiePrefix","url","test","protocol","port","fileName","replace"],"mappings":";sBAEA,MACMA,EAAY,SAYX,SAASC,EAAeC,EAAWC,GACxC,MAAMC,EAAS,CACbC,QAAS,IAAKH,EAAUG,SACxBC,OAAQ,IAAMJ,EAAUI,QAAU,KAEpC,IAAK,IAAIC,KAAOJ,EACdC,EAAOC,QAAQE,GAAOJ,EAAUI,GAGlC,OAAOH,CACT,CAOO,SAASI,EACdC,EACAC,EAAiBC,GAEjB,MAAMC,EAAgBC,EAAOC,MAAML,EAAIM,QAAgB,QAAK,IAEtDZ,EAAY,GAElB,IAAK,IAAIa,KAAcJ,EACrB,GAAII,EAAWC,WAvCE,wBAuCwB,CACvC,MAAMC,EAAaF,EAAWG,MAAMC,IAGpC,GAAIF,EAAY,CACd,IAAIG,EAAMT,EAAcI,GACpBhB,EAAUsB,KAAKD,KACjBA,GAAOX,GAAkBC,GAAuBU,EAAKH,EAAYT,IAG/DY,EAAIJ,WAAW,QACjBI,EAAO,GAAEZ,EAAIc,YAAYF,KAG3BlB,EAAUe,GAAcG,GAK9B,OAAOlB,CACT,CAEA,SAASQ,EAAsBa,EAAMN,EAAYT,GAC/C,MAAMgB,EAAWP,EAAWQ,QAAQ,KAAM,IAAIA,QAAQ,MAAO,KAC7D,MAAQ,GAAEjB,EAAIc,wBAAwBC,KAAQC,GAChD"}