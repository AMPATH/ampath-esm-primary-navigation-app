{"version":3,"file":"import-map-overrides-api.js","sources":["../src/util/includes.js","../src/api/js-api.js","../src/util/string-regex.js","../src/util/url-parameter.js"],"sourcesContent":["export function includes(obj, item) {\n  if (Array.isArray(obj)) {\n    for (let i = 0; i < obj.length; i++) {\n      if (obj[i] === item) {\n        return true;\n      }\n    }\n    return false;\n  } else if (typeof obj === \"string\") {\n    return obj.indexOf(item) >= 0;\n  } else {\n    throw Error(`Can't call includes on ${typeof obj}`);\n  }\n}\n","import { escapeStringRegexp } from \"../util/string-regex\";\nimport { includes } from \"../util/includes.js\";\nimport { getParameterByName } from \"../util/url-parameter\";\n\nconst localStoragePrefix = \"import-map-override:\";\nconst disabledOverridesLocalStorageKey = \"import-map-overrides-disabled\";\nconst externalOverridesLocalStorageKey = \"import-map-overrides-external-maps\";\nconst overrideAttribute = \"data-is-importmap-override\";\nconst domainsMeta = \"import-map-overrides-domains\";\nconst allowListPrefix = \"allowlist:\";\nconst denyListPrefix = \"denylist:\";\nexport const queryParamOverridesName = \"imo\";\n\nconst importMapMetaElement = document.querySelector(\n  'meta[name=\"importmap-type\"]'\n);\n\nconst domainsElement = document.querySelector(`meta[name=\"${domainsMeta}\"]`);\n\nconst externalOverrideMapPromises = {};\n\nexport const importMapType = importMapMetaElement\n  ? importMapMetaElement.getAttribute(\"content\")\n  : \"importmap\";\n\nexport let isDisabled;\n\nif (domainsElement) {\n  const content = domainsElement.getAttribute(\"content\");\n  if (!content) {\n    console.warn(`Invalid ${domainsMeta} meta element - content required.`);\n  }\n\n  const matchHostname = (domain) =>\n    new RegExp(escapeStringRegexp(domain).replace(\"\\\\*\", \".+\")).test(\n      window.location.hostname\n    );\n\n  if (content.indexOf(allowListPrefix) === 0) {\n    const allowedDomains = content.slice(allowListPrefix.length).split(\",\");\n    isDisabled = !allowedDomains.some(matchHostname);\n  } else if (content.indexOf(denyListPrefix) === 0) {\n    const deniedDomains = content.slice(denyListPrefix.length).split(\",\");\n    isDisabled = deniedDomains.some(matchHostname);\n  } else {\n    // eslint-disable-next-line no-console\n    console.log(\n      `Invalid ${domainsMeta} meta content attribute - must start with ${allowListPrefix} or ${denyListPrefix}`\n    );\n  }\n} else {\n  isDisabled = false;\n}\n\nif (!canAccessLocalStorage()) {\n  console.warn(\n    \"Disabling import-map-overrides, since local storage is not readable\"\n  );\n  isDisabled = true;\n}\n\nif (!isDisabled) {\n  init();\n}\n\nfunction init() {\n  const serverOverrides = importMapMetaElement\n    ? importMapMetaElement.hasAttribute(\"server-cookie\")\n    : false;\n  const serverOnly = importMapMetaElement\n    ? importMapMetaElement.hasAttribute(\"server-only\")\n    : false;\n\n  let defaultMapPromise;\n\n  window.importMapOverrides = {\n    addOverride(moduleName, url) {\n      const portRegex = /^\\d+$/g;\n      if (portRegex.test(url)) {\n        url = imo.getUrlFromPort(moduleName, url);\n      }\n      const key = localStoragePrefix + moduleName;\n      localStorage.setItem(key, url);\n      if (serverOverrides) {\n        document.cookie = `${key}=${url}`;\n      }\n      fireChangedEvent();\n      return imo.getOverrideMap();\n    },\n    getOverrideMap(includeDisabled = false) {\n      const overrides = createEmptyImportMap();\n      const disabledOverrides = imo.getDisabledOverrides();\n\n      const setOverride = (moduleName, path) => {\n        if (includeDisabled || !(disabledOverrides.indexOf(moduleName) >= 0)) {\n          overrides.imports[moduleName] = path;\n        }\n      };\n\n      // get from localstorage\n      for (let i = 0; i < localStorage.length; i++) {\n        const key = localStorage.key(i);\n        if (key.indexOf(localStoragePrefix) === 0) {\n          setOverride(\n            key.slice(localStoragePrefix.length),\n            localStorage.getItem(key)\n          );\n        }\n      }\n\n      // get from url if query param exist\n      const queryParam = getParameterByName(\n        queryParamOverridesName,\n        window.location != window.parent.location\n          ? document.referrer\n          : window.location.href\n      );\n\n      if (queryParam) {\n        let queryParamImportMap;\n        try {\n          queryParamImportMap = JSON.parse(queryParam);\n        } catch (e) {\n          throw Error(\n            `Invalid importMap query param - text content must be json`\n          );\n        }\n        Object.keys(queryParamImportMap.imports).forEach((moduleName) => {\n          setOverride(moduleName, queryParamImportMap.imports[moduleName]);\n        });\n      }\n\n      return overrides;\n    },\n    removeOverride(moduleName) {\n      const key = localStoragePrefix + moduleName;\n      const hasItem = localStorage.getItem(key) !== null;\n      localStorage.removeItem(key);\n      if (serverOverrides) {\n        document.cookie = `${key}=; expires=Thu, 01 Jan 1970 00:00:01 GMT;`;\n      }\n      imo.enableOverride(moduleName);\n      fireChangedEvent();\n      return hasItem;\n    },\n    resetOverrides() {\n      Object.keys(imo.getOverrideMap(true).imports).forEach((moduleName) => {\n        imo.removeOverride(moduleName);\n      });\n      localStorage.removeItem(disabledOverridesLocalStorageKey);\n      localStorage.removeItem(externalOverridesLocalStorageKey);\n      fireChangedEvent();\n      return imo.getOverrideMap();\n    },\n    hasOverrides() {\n      return Object.keys(imo.getOverrideMap().imports).length > 0;\n    },\n    getUrlFromPort(moduleName, port) {\n      const fileName = moduleName.replace(/@/g, \"\").replace(/\\//g, \"-\");\n      return `//localhost:${port}/${fileName}.js`;\n    },\n    enableUI() {\n      const customElementName = \"import-map-overrides-full\";\n      const showWhenLocalStorage = \"show-when-local-storage\";\n      let customElement = document.querySelector(customElementName);\n\n      if (!customElement) {\n        customElement = document.createElement(customElementName);\n        customElement.setAttribute(showWhenLocalStorage, \"true\");\n        document.body.appendChild(customElement);\n      }\n\n      const localStorageKey = customElement.getAttribute(showWhenLocalStorage);\n      if (localStorageKey) {\n        localStorage.setItem(localStorageKey, true);\n        customElement.renderWithPreact();\n      }\n    },\n    mergeImportMap(originalMap, newMap) {\n      const outMap = createEmptyImportMap();\n      for (let i in originalMap.imports) {\n        outMap.imports[i] = originalMap.imports[i];\n      }\n      for (let i in newMap.imports) {\n        outMap.imports[i] = newMap.imports[i];\n      }\n      for (let i in originalMap.scopes) {\n        outMap.scopes[i] = originalMap.scopes[i];\n      }\n      for (let i in newMap.scopes) {\n        outMap.scopes[i] = newMap.scopes[i];\n      }\n      return outMap;\n    },\n    getDefaultMap() {\n      return (\n        defaultMapPromise ||\n        (defaultMapPromise = Array.prototype.reduce.call(\n          document.querySelectorAll(\n            `script[type=\"${importMapType}\"], script[type=\"overridable-importmap\"]`\n          ),\n          (promise, scriptEl) => {\n            if (scriptEl.hasAttribute(overrideAttribute)) {\n              return promise;\n            } else {\n              let nextPromise;\n              if (scriptEl.src) {\n                nextPromise = fetchExternalMap(scriptEl.src);\n              } else {\n                nextPromise = Promise.resolve(JSON.parse(scriptEl.textContent));\n              }\n\n              return Promise.all([promise, nextPromise]).then(\n                ([originalMap, newMap]) =>\n                  imo.mergeImportMap(originalMap, newMap)\n              );\n            }\n          },\n          Promise.resolve(createEmptyImportMap())\n        ))\n      );\n    },\n    getCurrentPageMap() {\n      return Promise.all([\n        imo.getDefaultMap(),\n        imo.getExternalOverrideMap(imo.getCurrentPageExternalOverrides()),\n      ]).then(([defaultMap, externalOverridesMap]) => {\n        return imo.mergeImportMap(\n          imo.mergeImportMap(defaultMap, externalOverridesMap),\n          initialOverrideMap\n        );\n      });\n    },\n    getCurrentPageExternalOverrides() {\n      const currentPageExternalOverrides = [];\n      document\n        .querySelectorAll(\n          `[${overrideAttribute}]:not([id=\"import-map-overrides\"])`\n        )\n        .forEach((externalOverrideEl) => {\n          currentPageExternalOverrides.push(externalOverrideEl.src);\n        });\n      return currentPageExternalOverrides;\n    },\n    getNextPageMap() {\n      return Promise.all([\n        imo.getDefaultMap(),\n        imo.getExternalOverrideMap(),\n      ]).then(([defaultMap, externalOverridesMap]) => {\n        return imo.mergeImportMap(\n          imo.mergeImportMap(defaultMap, externalOverridesMap),\n          imo.getOverrideMap()\n        );\n      });\n    },\n    disableOverride(moduleName) {\n      const disabledOverrides = imo.getDisabledOverrides();\n      if (!includes(disabledOverrides, moduleName)) {\n        localStorage.setItem(\n          disabledOverridesLocalStorageKey,\n          JSON.stringify(disabledOverrides.concat(moduleName))\n        );\n        fireChangedEvent();\n        return true;\n      } else {\n        return false;\n      }\n    },\n    enableOverride(moduleName) {\n      const disabledOverrides = imo.getDisabledOverrides();\n      const index = disabledOverrides.indexOf(moduleName);\n      if (index >= 0) {\n        disabledOverrides.splice(index, 1);\n        localStorage.setItem(\n          disabledOverridesLocalStorageKey,\n          JSON.stringify(disabledOverrides)\n        );\n        fireChangedEvent();\n        return true;\n      } else {\n        return false;\n      }\n    },\n    getDisabledOverrides() {\n      const disabledOverrides = localStorage.getItem(\n        disabledOverridesLocalStorageKey\n      );\n      return disabledOverrides ? JSON.parse(disabledOverrides) : [];\n    },\n    isDisabled(moduleName) {\n      return includes(imo.getDisabledOverrides(), moduleName);\n    },\n    getExternalOverrides() {\n      let localStorageValue = localStorage.getItem(\n        externalOverridesLocalStorageKey\n      );\n      return localStorageValue ? JSON.parse(localStorageValue).sort() : [];\n    },\n    addExternalOverride(url) {\n      url = new URL(url, document.baseURI).href;\n      const overrides = imo.getExternalOverrides();\n      if (includes(overrides, url)) {\n        return false;\n      } else {\n        localStorage.setItem(\n          externalOverridesLocalStorageKey,\n          JSON.stringify(overrides.concat(url))\n        );\n        fireChangedEvent();\n        return true;\n      }\n    },\n    removeExternalOverride(url) {\n      const overrides = imo.getExternalOverrides();\n      if (includes(overrides, url)) {\n        localStorage.setItem(\n          externalOverridesLocalStorageKey,\n          JSON.stringify(overrides.filter((override) => override !== url))\n        );\n        fireChangedEvent();\n        return true;\n      } else {\n        return false;\n      }\n    },\n    getExternalOverrideMap(externalOverrides = imo.getExternalOverrides()) {\n      return externalOverrides.reduce((result, externalOverride) => {\n        const fetchPromise =\n          externalOverrideMapPromises[externalOverride] ||\n          (externalOverrideMapPromises[externalOverride] =\n            fetchExternalMap(externalOverride));\n        return Promise.all([result, fetchPromise]).then(\n          ([firstMap, secondMap]) => {\n            return imo.mergeImportMap(firstMap, secondMap);\n          }\n        );\n      }, Promise.resolve(createEmptyImportMap()));\n    },\n    isExternalMapValid(importMapUrl) {\n      const promise =\n        externalOverrideMapPromises[importMapUrl] ||\n        (externalOverrideMapPromises[importMapUrl] =\n          fetchExternalMap(importMapUrl));\n      return promise.then(\n        () => !includes(imo.invalidExternalMaps, importMapUrl)\n      );\n    },\n    invalidExternalMaps: [],\n  };\n\n  const imo = window.importMapOverrides;\n\n  let canFireCustomEvents = true;\n  try {\n    if (CustomEvent) {\n      new CustomEvent(\"a\");\n    } else {\n      canFireCustomEvents = false;\n    }\n  } catch (err) {\n    canFireCustomEvents = false;\n  }\n\n  function fireChangedEvent() {\n    fireEvent(\"change\");\n  }\n\n  function fireEvent(type) {\n    // Set timeout so that event fires after the change has totally finished\n    setTimeout(() => {\n      const eventType = `import-map-overrides:${type}`;\n      const event = canFireCustomEvents\n        ? new CustomEvent(eventType)\n        : document.createEvent(\"CustomEvent\");\n      if (!canFireCustomEvents) {\n        event.initCustomEvent(eventType, true, true, null);\n      }\n      window.dispatchEvent(event);\n    });\n  }\n\n  const initialOverrideMap = imo.getOverrideMap();\n  const initialExternalOverrideMaps = imo.getExternalOverrides();\n\n  let referenceNode;\n\n  if (!serverOnly) {\n    const overridableImportMap = document.querySelector(\n      'script[type=\"overridable-importmap\"]'\n    );\n\n    referenceNode = overridableImportMap;\n\n    if (!referenceNode) {\n      const importMaps = document.querySelectorAll(\n        `script[type=\"${importMapType}\"]`\n      );\n      referenceNode = importMaps ? importMaps[importMaps.length - 1] : null;\n    }\n\n    if (overridableImportMap) {\n      if (overridableImportMap.src) {\n        throw Error(\n          `import-map-overrides: external import maps with type=\"overridable-importmap\" are not supported`\n        );\n      }\n      let originalMap;\n      try {\n        originalMap = JSON.parse(overridableImportMap.textContent);\n      } catch (e) {\n        throw Error(\n          `Invalid <script type=\"overridable-importmap\"> - text content must be json`\n        );\n      }\n\n      referenceNode = insertOverrideMap(\n        imo.mergeImportMap(originalMap, initialOverrideMap),\n        `import-map-overrides`,\n        referenceNode\n      );\n      insertAllExternalOverrideMaps();\n    } else {\n      insertAllExternalOverrideMaps();\n      if (Object.keys(initialOverrideMap.imports).length > 0) {\n        referenceNode = insertOverrideMap(\n          initialOverrideMap,\n          `import-map-overrides`,\n          referenceNode\n        );\n      }\n    }\n  }\n\n  fireEvent(\"init\");\n\n  function insertOverrideMap(map, id, referenceNode) {\n    const overrideMapElement = document.createElement(\"script\");\n    overrideMapElement.type = importMapType;\n    overrideMapElement.id = id; // for debugging and for UI to identify this import map as special\n    overrideMapElement.setAttribute(overrideAttribute, \"\");\n    if (typeof map === \"string\") {\n      overrideMapElement.src = map;\n    } else {\n      overrideMapElement.textContent = JSON.stringify(map, null, 2);\n    }\n\n    if (referenceNode) {\n      referenceNode.insertAdjacentElement(\"afterend\", overrideMapElement);\n    } else {\n      document.head.appendChild(overrideMapElement);\n    }\n\n    return overrideMapElement;\n  }\n\n  function fetchExternalMap(url) {\n    return fetch(url)\n      .then(\n        (r) => {\n          if (r.ok) {\n            return r.json().catch((err) => {\n              console.warn(\n                Error(\n                  `External override import map contained invalid json, at url ${r.url}. ${err}`\n                )\n              );\n              imo.invalidExternalMaps.push(r.url);\n              return createEmptyImportMap();\n            });\n          } else {\n            console.warn(\n              Error(\n                `Unable to download external override import map from url ${r.url}. Server responded with status ${r.status}`\n              )\n            );\n            imo.invalidExternalMaps.push(r.url);\n            return createEmptyImportMap();\n          }\n        },\n        () => {\n          console.warn(\n            Error(`Unable to download external import map at url '${url}'`)\n          );\n          imo.invalidExternalMaps.push(new URL(url, document.baseURI).href);\n          return createEmptyImportMap();\n        }\n      )\n      .then((importMap) => expandRelativeUrlsInImportMap(importMap, url));\n  }\n\n  function createEmptyImportMap() {\n    return { imports: {}, scopes: {} };\n  }\n\n  function insertAllExternalOverrideMaps() {\n    if (initialExternalOverrideMaps.length > 0) {\n      initialExternalOverrideMaps.forEach((mapUrl, index) => {\n        referenceNode = insertOverrideMap(\n          mapUrl,\n          `import-map-overrides-external-${index}`\n        );\n      });\n    }\n  }\n}\n\nfunction expandRelativeUrl(url, baseUrl) {\n  try {\n    const outUrl = new URL(url, baseUrl);\n    return outUrl.href;\n  } catch (err) {\n    return url;\n  }\n}\n\nfunction expandRelativeUrlImports(imports, baseUrl) {\n  return Object.entries(imports).reduce((result, [key, value]) => {\n    result[key] = expandRelativeUrl(value, baseUrl);\n    return result;\n  }, {});\n}\n\nfunction expandRelativeUrlsInImportMap(importMap, baseUrl) {\n  return {\n    imports: expandRelativeUrlImports(importMap.imports || {}, baseUrl),\n    scopes: Object.keys(importMap.scopes || {}).reduce((result, scopeKey) => {\n      result[scopeKey] = expandRelativeUrlImports(\n        importMap.scopes[scopeKey],\n        baseUrl\n      );\n      return result;\n    }, {}),\n  };\n}\n\nfunction canAccessLocalStorage() {\n  try {\n    localStorage.getItem(\"test\");\n    return true;\n  } catch {\n    return false;\n  }\n}\n","// from https://github.com/sindresorhus/escape-string-regexp\nexport const escapeStringRegexp = (string) => {\n  if (typeof string !== \"string\") {\n    throw new TypeError(\"Expected a string\");\n  }\n\n  // Escape characters with special meaning either inside or outside character sets.\n  // Use a simple backslash escape when it’s always valid, and a `\\xnn` escape when the simpler form would be disallowed by Unicode patterns’ stricter grammar.\n  return string.replace(/[|\\\\{}()[\\]^$+*?.]/g, \"\\\\$&\").replace(/-/g, \"\\\\x2d\");\n};\n","// https://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript\nexport function getParameterByName(name, url = window.location.href) {\n  name = name.replace(/[\\[\\]]/g, \"\\\\$&\");\n  var regex = new RegExp(\"[?&]\" + name + \"(=([^&#]*)|&|#|$)\"),\n    results = regex.exec(url);\n  if (!results) return null;\n  if (!results[2]) return \"\";\n  return decodeURIComponent(results[2].replace(/\\+/g, \" \"));\n}\n"],"names":["includes","obj","item","Array","isArray","i","length","indexOf","Error","concat","_typeof","isDisabled","localStoragePrefix","disabledOverridesLocalStorageKey","externalOverridesLocalStorageKey","overrideAttribute","domainsMeta","allowListPrefix","denyListPrefix","importMapMetaElement","document","querySelector","domainsElement","externalOverrideMapPromises","importMapType","getAttribute","content","console","warn","matchHostname","domain","RegExp","string","TypeError","replace","escapeStringRegexp","test","window","location","hostname","slice","split","some","log","expandRelativeUrlImports","imports","baseUrl","Object","entries","reduce","result","_ref9","_ref10","_slicedToArray","key","value","url","URL","href","err","expandRelativeUrl","localStorage","getItem","_unused","canAccessLocalStorage","defaultMapPromise","serverOverrides","hasAttribute","serverOnly","importMapOverrides","addOverride","moduleName","imo","getUrlFromPort","setItem","cookie","fireChangedEvent","getOverrideMap","includeDisabled","arguments","undefined","overrides","scopes","disabledOverrides","getDisabledOverrides","setOverride","path","queryParam","name","results","exec","decodeURIComponent","getParameterByName","parent","referrer","queryParamImportMap","JSON","parse","e","keys","forEach","removeOverride","hasItem","removeItem","enableOverride","resetOverrides","hasOverrides","port","fileName","enableUI","customElementName","showWhenLocalStorage","customElement","createElement","setAttribute","body","appendChild","localStorageKey","renderWithPreact","mergeImportMap","originalMap","newMap","outMap","getDefaultMap","prototype","call","querySelectorAll","promise","scriptEl","nextPromise","src","fetchExternalMap","Promise","resolve","textContent","all","then","_ref","_ref2","getCurrentPageMap","getExternalOverrideMap","getCurrentPageExternalOverrides","_ref3","_ref4","defaultMap","externalOverridesMap","initialOverrideMap","currentPageExternalOverrides","externalOverrideEl","push","getNextPageMap","_ref5","_ref6","disableOverride","stringify","index","splice","getExternalOverrides","localStorageValue","sort","addExternalOverride","baseURI","removeExternalOverride","filter","override","externalOverride","fetchPromise","_ref7","_ref8","firstMap","secondMap","isExternalMapValid","importMapUrl","invalidExternalMaps","canFireCustomEvents","CustomEvent","fireEvent","type","setTimeout","eventType","event","createEvent","initCustomEvent","dispatchEvent","referenceNode","initialExternalOverrideMaps","overridableImportMap","importMaps","insertOverrideMap","insertAllExternalOverrideMaps","map","id","overrideMapElement","insertAdjacentElement","head","fetch","r","ok","json","catch","status","importMap","scopeKey","expandRelativeUrlsInImportMap","mapUrl","init"],"mappings":"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"}