import { node_fs, node_path, rspack } from "./131.mjs";
const DEFAULT_RUST_TRACE_LAYER = 'perfetto';
async function applyProfile(filterValue, traceLayer = DEFAULT_RUST_TRACE_LAYER, traceOutput) {
    const { asyncExitHook } = await import("exit-hook");
    if ('logger' !== traceLayer && 'perfetto' !== traceLayer) throw new Error(`unsupported trace layer: ${traceLayer}`);
    const timestamp = Date.now();
    const defaultOutputDir = node_path.resolve(`.rspack-profile-${timestamp}-${process.pid}`);
    if (traceOutput) {
        if ('stdout' !== traceOutput && 'stderr' !== traceOutput) traceOutput = node_path.resolve(defaultOutputDir, traceOutput);
    } else {
        const defaultRustTracePerfettoOutput = node_path.resolve(defaultOutputDir, 'rspack.pftrace');
        const defaultRustTraceLoggerOutput = 'stdout';
        const defaultTraceOutput = 'perfetto' === traceLayer ? defaultRustTracePerfettoOutput : defaultRustTraceLoggerOutput;
        traceOutput = defaultTraceOutput;
    }
    await ensureFileDir(traceOutput);
    await rspack.experiments.globalTrace.register(filterValue, traceLayer, traceOutput);
    asyncExitHook(rspack.experiments.globalTrace.cleanup, {
        wait: 500
    });
}
async function ensureFileDir(outputFilePath) {
    const dir = node_path.dirname(outputFilePath);
    await node_fs.promises.mkdir(dir, {
        recursive: true
    });
}
export { applyProfile };
